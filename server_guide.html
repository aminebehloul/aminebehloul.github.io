import socket
from http.server import HTTPServer, BaseHTTPRequestHandler, ThreadingHTTPServer

ONE_GB = 1_000_000_000

def get_best_ip():
    """
    Determines the primary IP address by attempting to connect to a public DNS.
    This identifies the interface actually used for network traffic.
    """
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    try:
        # Connect to Google DNS (doesn't actually send data)
        s.connect(("8.8.8.8", 80))
        primary_ip = s.getsockname()[0]
    except Exception:
        primary_ip = None
    finally:
        s.close()
    return primary_ip

def get_all_lan_ips():
    """
    Returns a list of all potential LAN IPs, excluding loopback (127.x) 
    and APIPA/Link-Local (169.254.x).
    """
    ip_list = []
    try:
        hostname = socket.gethostname()
        for ip in socket.gethostbyname_ex(hostname)[2]:
            # Filter out localhost and auto-configured link-local IPs
            if not ip.startswith("127.") and not ip.startswith("169.254."):
                ip_list.append(ip)
    except:
        pass
    return list(set(ip_list))

class SpeedTestHandler(BaseHTTPRequestHandler):
    def log_message(self, format, *args): return

    def do_HEAD(self):
        self.send_response(200)
        self.send_header("Content-type", "application/octet-stream")
        self.send_header("Content-Length", str(ONE_GB))
        self.end_headers()

    def do_GET(self):
        self.send_response(200)
        self.send_header("Content-type", "application/octet-stream")
        self.send_header("Content-Length", str(ONE_GB))
        self.send_header("Cache-Control", "no-store")
        self.end_headers()

        chunk = b"\0" * (256 * 1024)
        try: self.connection.setsockopt(socket.SOL_SOCKET, socket.SO_SNDBUF, 4 * 1024 * 1024)
        except: pass

        try:
            while True: self.wfile.write(chunk)
        except (BrokenPipeError, ConnectionResetError, ConnectionAbortedError): pass

    def do_POST(self):
        self.send_response(200)
        self.end_headers()
        try: self.connection.setsockopt(socket.SOL_SOCKET, socket.SO_RCVBUF, 4 * 1024 * 1024)
        except: pass

        try:
            while True:
                if not self.rfile.read(256 * 1024): break
        except (BrokenPipeError, ConnectionResetError, ConnectionAbortedError): pass

if __name__ == '__main__':
    httpd = ThreadingHTTPServer(("0.0.0.0", 8000), SpeedTestHandler)
    httpd.allow_reuse_address = True
    
    primary_ip = get_best_ip()
    all_ips = get_all_lan_ips()
    
    print(f"‚úÖ Speed Test Server running on port 8000")
    print("--------------------------------------------------")
    
    # 1. Show the best guess first
    if primary_ip:
        print(f"‚≠ê RECOMMENDED (Primary):")
        print(f"   üëâ http://{primary_ip}:8000")
        
        # Remove primary from list to avoid duplication
        if primary_ip in all_ips:
            all_ips.remove(primary_ip)

    # 2. Show others if they exist (e.g. secondary interface)
    if all_ips:
        print("\nOther detected interfaces:")
        for ip in all_ips:
            print(f"   üëâ http://{ip}:8000")

    if not primary_ip and not all_ips:
         print("   üëâ http://<YOUR_PC_IP>:8000")

    print("--------------------------------------------------")
    
    try: httpd.serve_forever()
    except KeyboardInterrupt: pass
    httpd.server_close()
